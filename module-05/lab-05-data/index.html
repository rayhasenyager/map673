<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Kenya Livestock Populations</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <script src='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.1/simple_statistics.js"></script>

    <link href='https://api.mapbox.com/mapbox.js/v2.2.4/mapbox.css' rel='stylesheet' />

    <style>
        body {
            margin: 0;
            padding: 0;
            background: whitesmoke;
            font-family: "Work Sans", sans-serif;
        }
        
        #side-panel {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 33%;
            background: whitesmoke;
            border-right: 2px solid #8B4513;
            overflow-y: scroll;
        }
        
        h1 {
            padding: 8px 25px 8px 15px;
            margin: 0;
            background: #8B4513;
            color: whitesmoke;
            font-weight: 400;
            font-size: 1.5em;
            text-align: right;
        }
        
        h2 {
            margin: 0;
            padding: 8px 25px 8px 15px;
            color: #8B4513;
            font-weight: 500;
            font-size: 1.2em;
            text-align: right;
        }
        
        #side-panel p {
            margin: 8px 0 4px;
            padding: 0 25px 0 15px;
            color: #3d3d3d;
            text-align: right;
            font-size: 1em;
        }
        
        #side-panel p:after {
            content: '';
            display: block;
            clear: both;
        }
        
        #side-panel img {
            float: right;
            margin: 0 0 15px 15px;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 67%;
        }
        
        #legend {
            position: absolute;
            right: 15px;
            bottom: 20px;
            padding: 8px 15px;
            background: whitesmoke;
            border: 2px solid #8B4513;
            border-radius: 3px;
            color: #8B4513;
            width: 160px;
        }
        
        #legend h3 {
            text-align: left;
            font-weight: 500;
            margin: 10px 0 20px;
        }
        
        #legend h4 {
            text-align: left;
            font-weight: 500;
            margin: 10px 0 20px;
        }
        #legend p {
            margin: 0 0 5px 0;
        }
        
        #legend span {
            display: block;
            border-radius: 50%/50%;
            float: left;
            height: 15px;
            width: 15px;
            text-align: right;
            font-size: 9px;
            color: #8B4513;
            margin-right: 10px;
        }
        #legend span.square {
            border-radius: 0;
        }
        #legend a {
            color: #8B4513;
        }
        
        #info {
            padding: 8px 15px;
            background: whitesmoke;
            border: 2px solid #8B4513;
            border-radius: 3px;
            color: #8B4513;
            position: absolute;
            font-size: 1em;
            max-width: 200px;
            display: none;
        }
        
        #info span:last-child {
            font-size: 1.3em;
            font-weight: 500;
        }
        
        #info p {
            margin: 3px 0 4px;
        }
        
        .cattle {
            color: #6813D2;
        }
        
        .goats {
            color: #DAA520;
        }
        
        .sheep {
            color: #008000;
        }
        
        .density {
            color: #CD853F;
        }

    </style>
</head>

<body>

    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>

    <div id='map'></div>
    <div id='side-panel'>
        <h1>Livestock populations in Kenya</h1>
        <p>Discovering where livestock are most concentrated will aid the firm in developing regional sales areas. The map is one factor among many to develop a sales plan in Kenya. Other areas that should be investigated and mapped are urban development, threat zones, and competitors.</p>
        <h2> About the map</h2>
        <p>The map displays by each county rings, scaled to the population, of each livestock catogry. The counties are also displayed and are categorized nased on density. Hovering the mouse over each green ring will display an information window with County name, population, and specific density.</p>
        <h2> About the data</h2>
        <p>The data was mined from the Kenya Open Data (https://opendata.go.ke/). Density was calculated using each county's area in kilometers.</p>
    </div>
    <div id="legend">
        <h3>Livestock per county</h3>
        <p class="cattle"><span style='background:#6813D2;'></span>
            <label> Cattle</label>
        </p>
        <p class="goats"><span style='background:#DAA520;'></span>
            <label> Goats</label>
        </p>
        <p class="sheep"><span style='background:#008000;'></span>
            <label> Sheep</label>
        </p>
        <h4>Counties (livestock per sq km):</h4>
        <p class="zero"><span class="square" style='background:#ca641c;'></span>
            <label> 21.41 - 55.99</label>
        </p>
        <p class="one"><span class="square" style='background:#9d4e15;'></span>
            <label> 71.76 - 95.5</label>
        </p>
        <p class="two"><span class="square" style='background:#874312;'></span>
            <label> 137.84 - 190.62</label>
        </p>
        <p class="three"><span class="square" style='background:#5a2d0c;'></span>
            <label> 195.8 - 263.93</label>
        </p>
        <p class="four"><span class="square" style='background:#2d1606;'></span>
            <label> 296.34 - 362.96</label>
        </p>
        <small>Source: <a href="https://opendata.go.ke/">Kenya Open Data</a></small>
    </div>

    <div id="info">
        <p>County: <span></span></p>
        <p class="cattle">Cattle <span></span>: <span></span></p>
        <p class="goats">Goats <span></span>: <span></span></p>
        <p class="sheep">Sheep <span></span>: <span></span></p>
        <p class="density">Density <span></span>: <span></span></p>
    </div>

    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>

    <script>
        var dataLayer,
            cattle,
            goats,
            sheep,
            total,
            density,
            scaleFactor = .05;

        L.mapbox.accessToken = 'pk.eyJ1IjoicmF5aGFzZW55YWdlciIsImEiOiJjaW03djhsZGswMHBvdm1tMHdvam54djRzIn0.E4iemJxzce4ZKFxgLjT57w';

        var map = L.mapbox.map('map', 'mapbox.outdoors', {
            center: [-.23, 37.8],
            zoom: 7,
            minZoom: 6,
            maxZoom: 9,
            maxBounds: L.latLngBounds([-6.22, 27.72], [5.76, 47.83])
        });

        var countyCentroids = omnivore.csv('livestock_county_2009.csv')
            .on('ready', function(e) {
                drawMap(e.target.toGeoJSON());
            })
            .on('error', function(e) {
                console.log(e.error[0].message);
            });

        function drawMap(stockData) {
            // access to stockData here
        }

        function drawMap(stockData) {

            cattle = L.geoJson(stockData, {
                pointToLayer: function(feature, layer) {
                    return L.circleMarker(layer, {
                        radius: calcRadius(Number(feature.properties.Cattle)),
                        color: '#6813D2',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0
                    });
                }
            }).addTo(map);

            goats = L.geoJson(stockData, {
                pointToLayer: function(feature, layer) {
                    return L.circleMarker(layer, {
                        radius: calcRadius(Number(feature.properties.Goats)),
                        color: '#DAA520',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0
                    });
                }
            }).addTo(map);

            sheep = L.geoJson(stockData, {
                pointToLayer: function(feature, layer) {
                    return L.circleMarker(layer, {
                        radius: calcRadius(Number(feature.properties.Sheep)),
                        color: '#008000',
                        opacity: 1,
                        weight: 2,
                        fillOpacity: 0
                    });
                }
            }).addTo(map);
            drawLegend();
            infoWindow();
        }

        function calcRadius(val) {
            var radius = Math.sqrt(val / Math.PI);
            return radius * scaleFactor;
        }

        function drawLegend() {

            var legend = $('.legend');

            legend.html()
        }

        $.getJSON('county.geojson', function(county) {

            dataLayer = L.geoJson(county, {
                style: function(feature) {
                    return {
                        color: '#dddddd', //grey borders
                        weight: 2, //border thickness
                        fillOpacity: .3, //no opacity
                        fillColor: '#CCC7B3'
                    };
                }
            });
            drawCounties(county);
        });

        function infoWindow() {

            var info = $('#info');

            sheep.on('mouseover', function(e) {
                var props = e.layer.feature.properties;

                info.show();
                $('#info span').text(props.County);
                $(".cattle span:first-child").text(' ');
                $(".goats span:first-child").text('');
                $(".sheep span:first-child").text(' ');
                $(".density span:first-child").text(' ');

                $(".cattle span:last-child").text(props.Cattle.toLocaleString());
                $(".goats span:last-child").text(props.Goats.toLocaleString());
                $(".sheep span:last-child").text(props.Sheep.toLocaleString());
                $(".density span:last-child").text(props.density.toLocaleString());

                e.layer.setStyle({
                    fillOpacity: .4
                });
            });

            sheep.on('mouseout', function(e) {
                info.hide();
                e.layer.setStyle({
                    fillOpacity: 0
                });
            });

            $(document).mousemove(function(e) {
                // first offset from the mouse position of the info window
                info.css({
                    "left": e.pageX + 6,
                    "top": e.pageY - info.height() - 15
                });
                // if it crashes into the top, flip it lower right
                if (info.offset().top < 4) {
                    info.css({
                        "top": e.pageY + 15
                    });
                }
                // do the same for crashing into the right
                if (info.offset().left + info.width() >= $(document).width() - 40) {
                    info.css({
                        "left": e.pageX - info.width() - 30
                    });
                }
            });
        }

        function drawCounties(county) {
            dataLayer = L.geoJson(county, {

                // initially set polygon border and fill properties
                style: function(feature) {
                        return {
                            color: '#A9A9A9',
                            weight: 1,
                            fillOpacity: 1,
                            fillColor: '#1f78b4'
                        }
                    }
                    // add polygons to the map    
            }).addTo(map).bringToBack();
            // fires the function to update the map for user functionality
            updateMap();
        }

        function updateMap() {

            var breaks = getClassBreaks();

            dataLayer.eachLayer(function(layer) {
                layer.setStyle({
                    color: '#A9A9A9',
                    weight: 1,
                    fillColor: getColor(layer.feature.properties.density, breaks),
                    fillOpacity: 1,
                });

                var props = layer.feature.properties;
            });
            updateLegend(breaks);
        }

        function updateLegend(breaks) {

            var legend = $('.legend').html("<h3>% Growth: " + (Number(density)) + "</h3><ul>");

            for (var i = 0; i < breaks.length - 1; i++) {

                var color = getColor(breaks[i + 1], breaks);

                $('.legend ul').append('<li><span style="background:' + color + '"></span> ' + breaks[i] + ' &mdash; ' + breaks[i + 1] + '</li>');
            }

            legend.append("</ul>");
        }

        function getClassBreaks() {

            var values = [];

            dataLayer.eachLayer(function(layer) {
                var value = layer.feature.properties.density;

                values.push(value);
            });

            var clusters = ss.ckmeans(values, 5);

            var breaks = clusters.map(function(cluster) {
                return [cluster[0], cluster.pop()];
            });

            return breaks;
        }

        function getColor(d, breaks) {

            if (d <= breaks[0][1]) {
                return '#ca641c';
            } else if (d <= breaks[1][1]) {
                return '#9d4e15';
            } else if (d <= breaks[2][1]) {
                return '#874312';
            } else if (d <= breaks[3][1]) {
                return '#5a2d0c'
            } else if (d <= breaks[4][1]) {
                return '#2d1606'
            }
        }

    </script>
</body>

</html>
